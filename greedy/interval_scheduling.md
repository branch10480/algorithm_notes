# 区間スケジューリング問題

## 注目する性質

貪欲法に限らず、 **探索範囲をあらかじめ絞れないかを考える** ことは大変有効です。

そのときに注目すべきパターンに以下があります。

> x に対する関数 `f(x)` の最大値を求めたいです。<br>
> ここで任意の x に対してそれを少し変形することで、ある性質 P を満たすような x とよく似た別解 x' が得られ、
> ```
> f(x') >= f(x)
> ```
> が成立することが示せたとします。<br>
> このとき、 x 全体のうち P を満たすもののみに絞って考えたとしても、その中に　f(x) が最大となるような x が含まれていると言えます。

この性質を満たす問題は数多くありますが、その中でも有名な **区間スケジューリング問題** について考えています。

## 例題

> N個の仕事があり、 i(=0,1,...,N-1) 番目の仕事は時刻 si に開始し、時刻 ti に終了します。
> 
> そして、これらの中から自分が行う仕事をできる限り多く選びたいとします。<br>
> ただし、時刻が重なっている複数の仕事を選ぶことはできません。
> 
> この時、最大で何この仕事をこなすことができるでしょうか。

## 回答への足掛かり

この問題で言う `仕事` とは数理的には `区間` です。

貪欲法の適用を考えるにあたり、まずは与えられた N個の区間に対して、**どの順番で選ぶ・選ばないの選択をしていくかを上手く定めることが重要です。

まずは `区間の終端時刻` が小さい順にソートします。

一般に、 **区間に対する問題に取り組むときは、まず区間の終端時刻でソートすると考えやすくなることが多い** です。

このとき、一番終了時間が早い区間を `p` とします。

この p はとりあえず選んでしまって良いと言えます。このとき、本ページであげた [注目する性質](#注目する性質) における性質を考えます。

任意の区間の選び方について、選ぶ区間の個数を減らすことなく、その中に区間 p が含まれるように変更を加えることができることを示していきます。

任意の選び方 x において、 **そのうちのもっとも左側にある区間** を p' とします。

p の定義により、
```
区間 p の終端時刻 <= 区間 p' の終端時刻
```
を満たします。

一方、 x において p' 以外の任意の区間 q に対して
```
区間 p' の終端時刻 <= 区間 q の開始時刻
```
を満たします。

これらを加味して、
```
区間 p の終端時刻 <= 区間 q の開始時刻
```
を満たします。

よって、区間の選び方 x において p と p' を交換しても

1. 選んだ区間の個数を悪化させることがない
2. 区間の重なりがない

以上の状態を保てるため、区間スケジューリング問題の解として `区間 p を含むもの` にのみ探索候補を絞っても良いことが分かります。

実際に行う処理としては、
``` 
区間 p を選んだ後、p と重なる区間を全て取り除き、残った区間に対してまた同様の手続きを繰り返す。
```

で、それをまとめると

- 残っている区間のうち、終端時刻がもっとも早いものを選ぶ（貪欲法）
- その選んだ区間と重なる区間を全て削除する

という操作を区間がなくなるまで繰り返すと言うことです。

## 解答

```swift
// 例: 区間を4つ用意する
let i: [(Int, Int)] = [
  (5, 7),
  (2, 4),
  (3, 10),
  (9, 10),
]

var sorted = i
var picked = [(Int, Int)]()

while !sorted.isEmpty {
  // 終端が若いものから順にソート
  sorted.sort(by: { $0.1 <= $1.1 })

  let first = sorted.removeFirst()
  picked.append(first)

  // 最初の要素と範囲がかぶっているものを削除する
  sorted.removeAll(where: { target in
    return target.0 < first.1
  })
}

print("Picked items are", picked)
```

